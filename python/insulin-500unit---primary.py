# Matthew J Carr, Alison K Wright, Lalantha Leelarantha, Hood Thabit, Nicola Milne, Naresh Kanumilli, Darren M Ashcroft, Martin K Rutter, 2024.

import sys, csv, re

codes = [{"code":"4258640000000000.0","system":"gprdproduct"},{"code":"2780940000000000.0","system":"gprdproduct"},{"code":"1.21866e+16","system":"gprdproduct"},{"code":"3345940000000000.0","system":"gprdproduct"},{"code":"1.06743e+16","system":"gprdproduct"},{"code":"1508340000000000.0","system":"gprdproduct"},{"code":"1.26007e+16","system":"gprdproduct"},{"code":"736141000000000.0","system":"gprdproduct"},{"code":"8264340000000000.0","system":"gprdproduct"},{"code":"2916940000000000.0","system":"gprdproduct"},{"code":"2953940000000000.0","system":"gprdproduct"},{"code":"3137140000000000.0","system":"gprdproduct"},{"code":"2953440000000000.0","system":"gprdproduct"},{"code":"1818240000000000.0","system":"gprdproduct"},{"code":"2267240000000000.0","system":"gprdproduct"},{"code":"2644640000000000.0","system":"gprdproduct"},{"code":"2018840000000000.0","system":"gprdproduct"},{"code":"4258540000000000.0","system":"gprdproduct"},{"code":"721341000000000.0","system":"gprdproduct"},{"code":"2266840000000000.0","system":"gprdproduct"},{"code":"2953540000000000.0","system":"gprdproduct"},{"code":"8264440000000000.0","system":"gprdproduct"},{"code":"2953040000000000.0","system":"gprdproduct"},{"code":"1821640000000000.0","system":"gprdproduct"},{"code":"1739940000000000.0","system":"gprdproduct"},{"code":"1621340000000000.0","system":"gprdproduct"},{"code":"3963940000000000.0","system":"gprdproduct"},{"code":"1.06006e+16","system":"gprdproduct"},{"code":"2868040000000000.0","system":"gprdproduct"},{"code":"2917140000000000.0","system":"gprdproduct"},{"code":"961041000000000.0","system":"gprdproduct"},{"code":"723241000000000.0","system":"gprdproduct"},{"code":"727341000000000.0","system":"gprdproduct"},{"code":"1.00446e+16","system":"gprdproduct"},{"code":"2953740000000000.0","system":"gprdproduct"},{"code":"2035540000000000.0","system":"gprdproduct"},{"code":"2954840000000000.0","system":"gprdproduct"},{"code":"926541000000000.0","system":"gprdproduct"},{"code":"1821540000000000.0","system":"gprdproduct"},{"code":"721041000000000.0","system":"gprdproduct"},{"code":"2182240000000000.0","system":"gprdproduct"},{"code":"2954140000000000.0","system":"gprdproduct"},{"code":"2267140000000000.0","system":"gprdproduct"},{"code":"2035440000000000.0","system":"gprdproduct"},{"code":"1.04942e+16","system":"gprdproduct"},{"code":"1.26242e+16","system":"gprdproduct"},{"code":"2953640000000000.0","system":"gprdproduct"},{"code":"1620640000000000.0","system":"gprdproduct"},{"code":"7341000000000.0","system":"gprdproduct"},{"code":"3914240000000000.0","system":"gprdproduct"},{"code":"2182140000000000.0","system":"gprdproduct"},{"code":"735041000000000.0","system":"gprdproduct"},{"code":"3137240000000000.0","system":"gprdproduct"},{"code":"2867940000000000.0","system":"gprdproduct"},{"code":"1.06007e+16","system":"gprdproduct"},{"code":"735341000000000.0","system":"gprdproduct"},{"code":"2158740000000000.0","system":"gprdproduct"},{"code":"763341000000000.0","system":"gprdproduct"},{"code":"735941000000000.0","system":"gprdproduct"},{"code":"1621140000000000.0","system":"gprdproduct"},{"code":"3922640000000000.0","system":"gprdproduct"},{"code":"8264240000000000.0","system":"gprdproduct"},{"code":"2868340000000000.0","system":"gprdproduct"},{"code":"1862040000000000.0","system":"gprdproduct"},{"code":"2796640000000000.0","system":"gprdproduct"},{"code":"1119740000000000.0","system":"gprdproduct"},{"code":"2954440000000000.0","system":"gprdproduct"},{"code":"5403540000000000.0","system":"gprdproduct"},{"code":"720341000000000.0","system":"gprdproduct"},{"code":"1616040000000000.0","system":"gprdproduct"},{"code":"1.26866e+16","system":"gprdproduct"},{"code":"724541000000000.0","system":"gprdproduct"},{"code":"723941000000000.0","system":"gprdproduct"},{"code":"3136940000000000.0","system":"gprdproduct"},{"code":"1271240000000000.0","system":"gprdproduct"},{"code":"1.00445e+16","system":"gprdproduct"},{"code":"3333840000000000.0","system":"gprdproduct"},{"code":"762441000000000.0","system":"gprdproduct"},{"code":"735841000000000.0","system":"gprdproduct"},{"code":"724041000000000.0","system":"gprdproduct"},{"code":"3869340000000000.0","system":"gprdproduct"},{"code":"2867840000000000.0","system":"gprdproduct"},{"code":"1736940000000000.0","system":"gprdproduct"},{"code":"2035640000000000.0","system":"gprdproduct"},{"code":"148841000000000.0","system":"gprdproduct"},{"code":"8263940000000000.0","system":"gprdproduct"},{"code":"726941000000000.0","system":"gprdproduct"},{"code":"4608740000000000.0","system":"gprdproduct"},{"code":"2954340000000000.0","system":"gprdproduct"},{"code":"721641000000000.0","system":"gprdproduct"},{"code":"759841000000000.0","system":"gprdproduct"},{"code":"727641000000000.0","system":"gprdproduct"},{"code":"1.02527e+16","system":"gprdproduct"},{"code":"719841000000000.0","system":"gprdproduct"},{"code":"1508440000000000.0","system":"gprdproduct"},{"code":"2035240000000000.0","system":"gprdproduct"},{"code":"1714040000000000.0","system":"gprdproduct"},{"code":"8264040000000000.0","system":"gprdproduct"},{"code":"735141000000000.0","system":"gprdproduct"},{"code":"2917340000000000.0","system":"gprdproduct"},{"code":"2953140000000000.0","system":"gprdproduct"},{"code":"721541000000000.0","system":"gprdproduct"},{"code":"2780740000000000.0","system":"gprdproduct"},{"code":"725841000000000.0","system":"gprdproduct"},{"code":"757641000000000.0","system":"gprdproduct"},{"code":"2954240000000000.0","system":"gprdproduct"},{"code":"779641000000000.0","system":"gprdproduct"},{"code":"1737040000000000.0","system":"gprdproduct"},{"code":"4608540000000000.0","system":"gprdproduct"},{"code":"962241000000000.0","system":"gprdproduct"},{"code":"725141000000000.0","system":"gprdproduct"},{"code":"3345840000000000.0","system":"gprdproduct"},{"code":"725341000000000.0","system":"gprdproduct"},{"code":"779141000000000.0","system":"gprdproduct"},{"code":"724341000000000.0","system":"gprdproduct"},{"code":"1821440000000000.0","system":"gprdproduct"},{"code":"1.26008e+16","system":"gprdproduct"},{"code":"3277740000000000.0","system":"gprdproduct"},{"code":"4126540000000000.0","system":"gprdproduct"},{"code":"2954640000000000.0","system":"gprdproduct"},{"code":"2724740000000000.0","system":"gprdproduct"},{"code":"736041000000000.0","system":"gprdproduct"},{"code":"2798840000000000.0","system":"gprdproduct"},{"code":"1616340000000000.0","system":"gprdproduct"},{"code":"823541000000000.0","system":"gprdproduct"},{"code":"720541000000000.0","system":"gprdproduct"},{"code":"726641000000000.0","system":"gprdproduct"},{"code":"2799040000000000.0","system":"gprdproduct"},{"code":"9641000000000.0","system":"gprdproduct"},{"code":"1.21865e+16","system":"gprdproduct"},{"code":"2953240000000000.0","system":"gprdproduct"},{"code":"2868240000000000.0","system":"gprdproduct"},{"code":"1.24862e+16","system":"gprdproduct"},{"code":"1621240000000000.0","system":"gprdproduct"},{"code":"2954740000000000.0","system":"gprdproduct"},{"code":"2952940000000000.0","system":"gprdproduct"},{"code":"1818540000000000.0","system":"gprdproduct"},{"code":"1.0674e+16","system":"gprdproduct"},{"code":"1749440000000000.0","system":"gprdproduct"},{"code":"2158540000000000.0","system":"gprdproduct"},{"code":"2724840000000000.0","system":"gprdproduct"},{"code":"4608640000000000.0","system":"gprdproduct"},{"code":"2867740000000000.0","system":"gprdproduct"},{"code":"2018940000000000.0","system":"gprdproduct"},{"code":"779841000000000.0","system":"gprdproduct"},{"code":"1861940000000000.0","system":"gprdproduct"},{"code":"2954040000000000.0","system":"gprdproduct"},{"code":"2868440000000000.0","system":"gprdproduct"},{"code":"1862340000000000.0","system":"gprdproduct"},{"code":"1818140000000000.0","system":"gprdproduct"},{"code":"1616240000000000.0","system":"gprdproduct"},{"code":"2867640000000000.0","system":"gprdproduct"},{"code":"6011840000000000.0","system":"gprdproduct"},{"code":"1.26009e+16","system":"gprdproduct"},{"code":"2953840000000000.0","system":"gprdproduct"},{"code":"1615940000000000.0","system":"gprdproduct"},{"code":"915641000000000.0","system":"gprdproduct"},{"code":"2796740000000000.0","system":"gprdproduct"},{"code":"727041000000000.0","system":"gprdproduct"},{"code":"2953340000000000.0","system":"gprdproduct"},{"code":"2034440000000000.0","system":"gprdproduct"},{"code":"1.06739e+16","system":"gprdproduct"},{"code":"1.14933e+16","system":"gprdproduct"},{"code":"5911540000000000.0","system":"gprdproduct"},{"code":"720941000000000.0","system":"gprdproduct"},{"code":"2868140000000000.0","system":"gprdproduct"},{"code":"2267040000000000.0","system":"gprdproduct"},{"code":"8264140000000000.0","system":"gprdproduct"},{"code":"1818440000000000.0","system":"gprdproduct"},{"code":"2780840000000000.0","system":"gprdproduct"},{"code":"2182340000000000.0","system":"gprdproduct"},{"code":"1419540000000000.0","system":"gprdproduct"},{"code":"3345640000000000.0","system":"gprdproduct"},{"code":"735541000000000.0","system":"gprdproduct"},{"code":"776041000000000.0","system":"gprdproduct"},{"code":"961141000000000.0","system":"gprdproduct"},{"code":"9677140000000000.0","system":"gprdproduct"},{"code":"724941000000000.0","system":"gprdproduct"},{"code":"722841000000000.0","system":"gprdproduct"},{"code":"1.04944e+16","system":"gprdproduct"},{"code":"1.02526e+16","system":"gprdproduct"},{"code":"1862240000000000.0","system":"gprdproduct"},{"code":"5910740000000000.0","system":"gprdproduct"},{"code":"9677040000000000.0","system":"gprdproduct"},{"code":"2182440000000000.0","system":"gprdproduct"},{"code":"2798940000000000.0","system":"gprdproduct"},{"code":"1152740000000000.0","system":"gprdproduct"},{"code":"6389640000000000.0","system":"gprdproduct"},{"code":"3345740000000000.0","system":"gprdproduct"},{"code":"2917040000000000.0","system":"gprdproduct"},{"code":"2158440000000000.0","system":"gprdproduct"},{"code":"6456440000000000.0","system":"gprdproduct"},{"code":"2158640000000000.0","system":"gprdproduct"},{"code":"1736840000000000.0","system":"gprdproduct"},{"code":"2266940000000000.0","system":"gprdproduct"},{"code":"1862440000000000.0","system":"gprdproduct"},{"code":"1821740000000000.0","system":"gprdproduct"},{"code":"763941000000000.0","system":"gprdproduct"},{"code":"725941000000000.0","system":"gprdproduct"},{"code":"1818340000000000.0","system":"gprdproduct"},{"code":"735441000000000.0","system":"gprdproduct"},{"code":"1.21864e+16","system":"gprdproduct"},{"code":"3137040000000000.0","system":"gprdproduct"},{"code":"2644740000000000.0","system":"gprdproduct"},{"code":"2034640000000000.0","system":"gprdproduct"},{"code":"4270840000000000.0","system":"gprdproduct"},{"code":"1.06741e+16","system":"gprdproduct"},{"code":"3914340000000000.0","system":"gprdproduct"},{"code":"2954540000000000.0","system":"gprdproduct"},{"code":"2952840000000000.0","system":"gprdproduct"},{"code":"1.24816e+16","system":"gprdproduct"},{"code":"734941000000000.0","system":"gprdproduct"},{"code":"4423040000000000.0","system":"gprdproduct"},{"code":"2917240000000000.0","system":"gprdproduct"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('insulin-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["insulin-500unit---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["insulin-500unit---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["insulin-500unit---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
